# compose.yaml
services:
  webapp-dev:
    build: &build-dev
      dockerfile: Dockerfile.webapp
      tags:
        - docker.io/username/webapp:latest
      cache_from:
        - docker.io/username/webapp:cache
      cache_to:
        - docker.io/username/webapp:cache

  webapp-release:
    build:
      <<: *build-dev
      x-bake:
        platforms:
          - linux/amd64
          - linux/arm64

  db:
    image: docker.io/username/db
    build:
      dockerfile: Dockerfile.db

...

# docker-bake.yaml

groups:
  default:
    targets:
      - api-dev
      - api-prod

targets:
  api-base:
    context: ./backend
    dockerfile: Dockerfile
    platforms:
      - linux/amd64
      - linux/arm64

  api-dev:
    inherits:
      - api-base
    tags:
      - jpmorganchase/backend:dev
    args:
      NODE_ENV: development
    output:
      - type=docker

  api-prod:
    inherits:
      - api-base
    tags:
      - jpmorganchase/backend:prod
    args:
      NODE_ENV: production
    output:
      - type=registry
...

# docker-bake.yaml

group:
  default:
    targets: 
      - frontend
      - backend
      - database

target:
  frontend:
    context: ./frontend
    dockerfile: Dockerfile
    tags:
      - myapp/frontend:latest
    platforms:
      - linux/amd64
      - linux/arm64
    output:
      - type=registry

  backend:
    context: ./backend
    dockerfile: Dockerfile
    tags:
      - myapp/backend:latest
    platforms:
      - linux/amd64
      - linux/arm64
    output:
      - type=registry

  database:
    context: ./database
    dockerfile: Dockerfile
    tags:
      - myapp/database:latest
    platforms:
      - linux/amd64
      - linux/arm64
    output:
      - type=registry
...

services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: myapp/frontend:latest

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: myapp/backend:latest

  database:
    build:
      context: ./database
      dockerfile: Dockerfile
    image: myapp/database:latest
